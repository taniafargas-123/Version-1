#include <SoftwareSerial.h>
#define aAmarilla 2
#define aRoja 6
#define aVerde 4
SoftwareSerial mySerial(10, 11); // RX, TX 

float temp = 0; //Todas la variables que se envian de satelite a tierra
float hum = 0;
float dist = 0;
float angulo = 90;
float m = 0;
float x = 0;
float y = 0;
float z = 0;

bool aDHT = 0;      // Variables de alarmas
bool aCerca = 0; 
bool aTiempo = 0;

int nextFalloTiempo; //Esperar para las alarmas
int intervalFalloTiempo = 5000;
//Funci√≥ comuna per a transmisor


void setup() {
  Serial.begin(9600);
  mySerial.begin(9600);
  pinMode(aAmarilla, OUTPUT);
  pinMode(aRoja, OUTPUT);
  pinMode(aVerde, OUTPUT);
}

void loop() {

//--------------------------------------------------
// LECTURA SERIAL DEL M√ìDULO
//--------------------------------------------------
if (mySerial.available()) {

    nextFalloTiempo = millis() + intervalFalloTiempo; 
    aTiempo = 0;

    String linea = mySerial.readStringUntil('\n');  
    Serial.println("Recibido: " + linea);

    char buffer[90];
    linea.toCharArray(buffer, 90);

    char *token = strtok(buffer, ":");

    while (token != NULL) {

      int id = atoi(token);      
      token = strtok(NULL, ":"); 
      if (token == NULL) break;

      float valor = atof(token);

      switch (id) {
        case 1: temp = valor; break;
        case 2: hum  = valor; break;
        case 3: dist = valor; break;
        case 4: angulo = valor; break;
        case 5: m = valor; break;
        case 6: x = valor; break;
        case 7: y = valor; break;
        case 8: z = valor; break;
        case 9: aDHT = valor; break;
        case 10: aCerca = valor; break;
      }

      token = strtok(NULL, ":");
    }

    //--------------------------------------------------
    //  üì§ Enviar TODOS los datos a Python en un solo mensaje
    //--------------------------------------------------

    String paquete = 
      "TEMP:" + String(temp) + ":" +
      "HUM:" + String(hum) + ":" +
      "DIST:" + String(dist) + ":" +
      "ANG:" + String(angulo) + ":" +
      "M:" + String(m) + ":" +
      "X:" + String(x) + ":" +
      "Y:" + String(y) + ":" +
      "Z:" + String(z) + ":" +
      "ADHT:" + String(aDHT) + ":" +
      "ACERCA:" + String(aCerca);

    Serial.println(paquete);   // Para debug
    mySerial.println(paquete); // üî• Python recibe ESTO
  }


  //--------------------------------------------------
  // TIMEOUT
  //--------------------------------------------------
  if (millis() > nextFalloTiempo) { //avisa si hay un fallo en un periodo de tiempo
    aTiempo = 1;
  }

  //--------------------------------------------------
  // LEDS
  //--------------------------------------------------
  digitalWrite(aAmarilla, aTiempo == 0 ? HIGH : LOW);
  digitalWrite(aRoja,     aDHT == 0    ? HIGH : LOW);
  digitalWrite(aVerde,    aCerca == 0  ? HIGH : LOW);


  //--------------------------------------------------
  // ENV√çO DE DATOS A SATELITE
  //--------------------------------------------------
  if (Serial.available()) {
    String cmd = Serial.readStringUntil('\n');
    Serial.println(cmd);
    mySerial.println(cmd);

  }
}
