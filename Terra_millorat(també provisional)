#include <SoftwareSerial.h>
#define aAmarilla 2
#define aRoja 6
#define aVerde 4
SoftwareSerial mySerial(10, 11); // RX, TX

float temp = 0;
float hum = 0;
float dist = 0;
float angulo = 90;
float m = 0;
float x = 0;
float y = 0;
float z = 0;

bool aDHT = 0;      // ID 9
bool aCerca = 0;    // ID 10
bool aTiempo = 0;

int nextFalloTiempo;
int intervalFalloTiempo = 5000;

void setup() {
  Serial.begin(9600);
  mySerial.begin(9600);
  pinMode(aAmarilla, OUTPUT);
  pinMode(aRoja, OUTPUT);
  pinMode(aVerde, OUTPUT);
}

void loop() {

  //--------------------------------------------------
  // LECTURA SERIAL DEL MÓDULO
  //--------------------------------------------------
  if (mySerial.available()) {

    nextFalloTiempo = millis() + intervalFalloTiempo;
    aTiempo = 0;

    String linea = mySerial.readStringUntil('\n');
    Serial.println(linea);

    char buffer[90];
    linea.toCharArray(buffer, 90);

    char *token = strtok(buffer, ":");

    while (token != NULL) {

      int id = atoi(token);
      token = strtok(NULL, ":");
      if (token == NULL) break;

      float valor = atof(token);

      switch (id) {
        case 1: temp = valor; break;
        case 2: hum  = valor; break;
        case 3: dist = valor; break;
        case 4: angulo = valor; break;
        case 5: m = valor; break;
        case 6: x = valor; break;
        case 7: y = valor; break;
        case 8: z = valor; break;
        case 9: aDHT = valor; break;
        case 10: aCerca = valor; break;
      }
      token = strtok(NULL, ":");
    }
  }

  //--------------------------------------------------
  // TIMEOUT
  //--------------------------------------------------
  if (millis() > nextFalloTiempo) {
    aTiempo = 1;
  }

  //--------------------------------------------------
  // LEDS (CORREGIDO: antes usabas "=" en vez de "==")
  //--------------------------------------------------
  digitalWrite(aAmarilla, aTiempo == 0 ? HIGH : LOW);
  digitalWrite(aRoja,     aDHT == 0    ? HIGH : LOW);
  digitalWrite(aVerde,    aCerca == 0  ? HIGH : LOW);


  //--------------------------------------------------
  // ENVÍO DE DATOS A PYTHON
  //--------------------------------------------------
  if (Serial.available()) {
    char Pausa = Serial.read();

    // comandos normales
    if (Pausa == '0') mySerial.println("0:");
    if (Pausa == '1') mySerial.println("1:");
    if (Pausa == '2') mySerial.println("2:");
    if (Pausa == '3') mySerial.println("3:");

    // ---- ENVÍO NUEVO ----
    // Enviar las 8 primeras juntas:
    String paquete = "";
    paquete += "1:" + String(temp)  + ":";
    paquete += "2:" + String(hum)   + ":";
    paquete += "3:" + String(dist)  + ":";
    paquete += "4:" + String(angulo)+ ":";
    paquete += "5:" + String(m)     + ":";
    paquete += "6:" + String(x)     + ":";
    paquete += "7:" + String(y)     + ":";
    paquete += "8:" + String(z);

    mySerial.println(paquete);   // ENVÍO DEL PACK DE 8 VARIABLES

    // Envío separado solo si se cumplen:
    if (aDHT == 1) {
      mySerial.println("9:1");
    }
    if (aCerca == 1) {
      mySerial.println("10:1");
    }

    delay(500);
  }
}
