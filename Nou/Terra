#include <SoftwareSerial.h>
#define aAmarilla 2
#define aVerde 4
#define aRoja 6
#define aAzul 8

//LoRa
SoftwareSerial mySerial(10, 11); // RX, TX 

// DATOS DEL DHT
float temperatura = 0;
float humedad = 0;
float dist = 0;

// POSICION 3D
float posicionX = 0;
float posicionY = 0;
float posicionZ = 0;

// ESTADO DE LAS ALARMAS
bool aDHT = 0;     
bool aCerca = 0; 
bool aTiempo = 0;

// INTERVALOS
int nextFalloTiempo;
int intervalFalloTiempo = 5000; // Tiempo a espera para que se cumpla la condicion de la alarma de tiempo


// =====================================================================================================================
//                                                       SETUP
// =====================================================================================================================
void setup() {
  Serial.begin(9600); //Canal con python 
  mySerial.begin(9600); //Canal LoRa
  pinMode(aAmarilla, OUTPUT);
  pinMode(aRoja, OUTPUT);
  pinMode(aVerde, OUTPUT);
}

// =====================================================================================================================
//                                                       LOOP
// =====================================================================================================================
  void loop() {

  //--------------------------------------------------
  //   1. Comunicacion Satelite -> Tierra -> Python
  //--------------------------------------------------
  if (mySerial.available()) {
    String input = mySerial.readStringUntil('\n');
    input.trim();
    Serial.println(input);
    nextFalloTiempo += millis(); // Se actualiza el periodo de la alarma
  }

  //--------------------------------------------------
  //      2. Condicion de la alarma de tiempo
  //--------------------------------------------------
  if (millis() > nextFalloTiempo) { //avisa si hay un fallo en un periodo de tiempo
    aTiempo = 1;
  }

  //--------------------------------------------------
  //             3. LEDs de cada alarma
  //--------------------------------------------------
  digitalWrite(aAmarilla, aTiempo == 0 ? LOW : HIGH); // si aTiempo es 0, el estado es LOW, y si es 1, estado HIGH
  digitalWrite(aRoja,     aDHT == 0    ? LOW : HIGH);
  digitalWrite(aVerde,    aCerca == 0  ? LOW : HIGH);


  //--------------------------------------------------
  //   4. Comunicacion Python -> Tierra -> Satelite
  //--------------------------------------------------
  if (Serial.available()) {
    String Comandos = Serial.readStringUntil('\n');  // leer de Python
    Comandos.trim();
    
    mySerial.println(Comandos); // enviar al otro Arduino
  }
}
